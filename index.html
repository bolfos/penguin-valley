<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Penguin Valley MMO</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyBSzq_-8WZ7xSqPqUd1nr_p4mNoHdFaZ3w",
 authDomain: "penguin-valley-9d490.firebaseapp.com",
 projectId: "penguin-valley-9d490"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let uid=null;

window.login=async()=>{
 try{
  await signInWithEmailAndPassword(auth,email.value,pass.value);
 }catch{
  await createUserWithEmailAndPassword(auth,email.value,pass.value);
 }
};

onAuthStateChanged(auth,async u=>{
 if(!u) return;
 uid=u.uid;
 loginBox.style.display="none";
 game.style.display="block";

 const ref=doc(db,"users",uid);
 const snap=await getDoc(ref);
 if(snap.exists()) Object.assign(state,snap.data());
 draw();
 watchPlayers();
 setInterval(draw,1000);
});
async function save(){
 if(uid) await setDoc(doc(db,"users",uid),state);
}
</script>

<style>
body{margin:0;font-family:Arial;background:#bfe7ff}
button,input{padding:6px;margin:4px}

/* VIEWPORT */
#viewport{
 width:100vw;
 height:100vh;
 overflow:scroll;
 border:4px solid #4aa3c4;
}

/* WORLD */
#world{
 width:2000px;
 height:2000px;
 background:linear-gradient(#e0f8ff,#b0e0ff);
 position:relative;
}

/* FARM */
#farm{
 position:absolute;
 top:300px;
 left:300px;
 display:grid;
 grid-template-columns:repeat(6,70px);
 gap:6px;
 background:#ffffffcc;
 padding:10px;
 border-radius:16px;
}

.tile{
 width:70px;height:70px;
 border-radius:14px;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:32px;
 background:#9fda9f;
 cursor:pointer;
}

/* BUILDINGS */
.building{
 position:absolute;
 width:120px;
 cursor:pointer;
}

/* PLAYERS */
.player{
 position:absolute;
 width:48px;
 pointer-events:none;
}

/* HUD */
#hud{
 position:fixed;
 top:5px;
 left:5px;
 background:white;
 padding:8px;
 border-radius:10px;
}
</style>
</head>

<body>

<div id="loginBox" style="text-align:center">
<h2>üêß Penguin Valley</h2>
<input id="email" placeholder="email">
<input id="pass" type="password">
<br>
<button onclick="login()">IntrƒÉ / CreeazƒÉ cont</button>
</div>

<div id="game" style="display:none">

<div id="hud"></div>

<div id="viewport">
 <div id="world" onclick="move(event)">

  <!-- BUILDINGS -->
  <img src="assets/market.png" class="building" style="top:150px;left:800px">
  <img src="assets/house.png" class="building" style="top:600px;left:400px">
  <img src="assets/storage.png" class="building" style="top:500px;left:900px">

  <!-- FARM -->
  <div id="farm"></div>

  <!-- PLAYERS -->
  <div id="players"></div>

 </div>
</div>

</div>

<script>
const crops={
 carrot:{t:60000,c:1,p:5},
 cabbage:{t:180000,c:3,p:15},
 flower:{t:360000,c:5,p:40}
};

let state={
 money:20,
 gems:0,
 sel:"carrot",
 tiles:{},
 x:400,
 y:400
};

const farm=document.getElementById("farm");
const hud=document.getElementById("hud");
const playersBox=document.getElementById("players");

function draw(){
 hud.textContent=`üí∞ ${state.money} | üíé ${state.gems}`;
 farm.innerHTML="";
 for(let i=0;i<24;i++){
  const d=document.createElement("div");
  d.className="tile";
  if(!state.tiles[i]){
   d.textContent="üå±";
   d.onclick=()=>plant(i);
  }else{
   d.textContent="ü•ï";
   d.onclick=()=>harvest(i);
  }
  farm.appendChild(d);
 }
 save();
}

function plant(i){
 if(state.tiles[i]) return;
 state.tiles[i]={t:"carrot",d:Date.now()};
}

function harvest(i){
 delete state.tiles[i];
 state.money+=5;
}

/* PLAYER MOVE */
function move(e){
 const r=e.currentTarget.getBoundingClientRect();
 state.x=e.clientX-r.left;
 state.y=e.clientY-r.top;
 save();
}

/* MULTIPLAYER */
function watchPlayers(){
 onSnapshot(collection(db,"users"),snap=>{
  playersBox.innerHTML="";
  snap.forEach(d=>{
   if(d.id===uid) return;
   const p=d.data();
   const img=document.createElement("img");
   img.src="assets/player.png";
   img.className="player";
   img.style.left=p.x+"px";
   img.style.top=p.y+"px";
   playersBox.appendChild(img);
  });
 });
}
</script>

</body>
</html>
